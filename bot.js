import { Telegraf, Markup } from 'telegraf';
import { config } from "./config.js";
import { setupPdfHandler } from './pdfHandler.js';
import { setupSpecialtiesHandlers, specialtiesKeyboard, mainMenuKeyboard } from './specialtiesHandlers.js';
import crypto from 'crypto';

const bot = new Telegraf(config.telegramToken, {
    telegram: { 
        agent: null, 
        webhookReply: false 
    },
    handlerTimeout: 30000
});

setupPdfHandler(bot);
setupSpecialtiesHandlers(bot);

const showMainMenu = (ctx) => {
    ctx.reply('üéõÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:', mainMenuKeyboard());
};

bot.start((ctx) => {
    showMainMenu(ctx);
});

bot.hears('üìã –ü–∞–º—è—Ç–∫–∞ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç—É', (ctx) => {
    ctx.reply('üìå –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:', 
        Markup.keyboard([
            ['üìö –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏'],
            ['üí∞ –í–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã'],
            ['üìÑ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã'],
            ['‚è≥ –°—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤'],
            ['üì§ –°–ø–æ—Å–æ–±—ã –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤'],
            ['üè† –ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ'],
            ['üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏'],
            ['üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã —É—á–µ–±–Ω–æ–π —á–∞—Å—Ç–∏'],
            ['üîô –ù–∞–∑–∞–¥']
        ])
        .resize()
    );
});

bot.hears('üìö –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏', (ctx) => {
    ctx.reply('üéì –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:', specialtiesKeyboard);
});

bot.hears(['üîô –ù–∞–∑–∞–¥', '‚ñ† –ù–∞–∑–∞–¥'], (ctx) => {
    showMainMenu(ctx);
});

bot.hears('üí∞ –í–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã', (ctx) => {
    ctx.replyWithMarkdown(`
*üí≥ –í–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è:*

–ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —É–¥–æ–±–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –∏—Ö —Å–µ–º–µ–π:

‚Ä¢ *–ï–¥–∏–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –∑–∞ —É—á–µ–±–Ω—ã–π –≥–æ–¥*  
  –ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏

‚Ä¢ *–û–ø–ª–∞—Ç–∞ –ø–æ —Å–µ–º–µ—Å—Ç—Ä–∞–º*  
  –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ –¥–≤–∞ —ç—Ç–∞–ø–∞

‚Ä¢ *–ì–∏–±–∫–∞—è —Ä–∞—Å—Å—Ä–æ—á–∫–∞*  
  –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

‚Ä¢ *–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫—Ä–µ–¥–∏—Ç*  
  –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å–æ –°–±–µ—Ä–±–∞–Ω–∫–æ–º

‚Ä¢ *–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª*  
  –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –æ–ø–ª–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è
    `);
});

bot.hears('üìÑ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã', (ctx) => {
    ctx.replyWithMarkdown(`
*üìã –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:*

1. –ü–∞—Å–ø–æ—Ä—Ç (–∫–æ–ø–∏—è)
2. –ê—Ç—Ç–µ—Å—Ç–∞—Ç/–¥–∏–ø–ª–æ–º (–∫–æ–ø–∏—è)
3. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ 3√ó4 (4 —à—Ç.)
    `);
});

bot.hears('‚è≥ –°—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤', (ctx) => {
    ctx.replyWithMarkdown(`
*üìÖ –°—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:*

‚Ä¢ *–ù–∞—á–∞–ª–æ –ø—Ä–∏–µ–º–∞:* 1 –∏—é–Ω—è  
‚Ä¢ *–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø—Ä–∏–µ–º–∞:* 31 –∞–≤–≥—É—Å—Ç–∞  
‚Ä¢ *–î–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ:* –¥–æ 15 –∏—é–ª—è (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –º–µ—Å—Ç)
    `);
});

bot.hears('üì§ –°–ø–æ—Å–æ–±—ã –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤', (ctx) => {
    ctx.replyWithMarkdown(`
*üì§ –°–ø–æ—Å–æ–±—ã –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:*

1. *–õ–∏—á–Ω–æ* –≤ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏  
2. *–û–Ω–ª–∞–π–Ω* —á–µ—Ä–µ–∑ —Å–∞–π—Ç –∫–æ–ª–ª–µ–¥–∂–∞  
3. *–ü–æ—á—Ç–æ–π* –Ω–∞ –∞–¥—Ä–µ—Å –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏  
4. *–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–æ–π* (—Å–∫–∞–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)  

–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ PDF –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:
    `, Markup.keyboard([
        ['üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã PDF'],
        ['üîô –ù–∞–∑–∞–¥']
    ]).resize());
});

bot.hears('üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã PDF', (ctx) => {
    ctx.reply('üìé –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF:');
});

bot.hears('üè† –ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ', (ctx) => {
    ctx.replyWithMarkdown(`
*üè° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–∏:*

–ö–æ–ª–ª–µ–¥–∂ –Ω–µ –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—â–µ–∂–∏—Ç–∏—è, –Ω–æ –º—ã –º–æ–∂–µ–º –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å:

‚Ä¢ *–ê—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä* –≤ —Ä–∞–π–æ–Ω–µ –∫–æ–ª–ª–µ–¥–∂–∞  
‚Ä¢ *–ì–æ—Å—Ç–µ–≤—ã–µ –¥–æ–º–∞* –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤  
‚Ä¢ *–•–æ—Å—Ç–µ–ª—ã* —Å –ø–æ—á–∞—Å–æ–≤–æ–π –æ–ø–ª–∞—Ç–æ–π  

–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ä–∏–µ–ª—Ç–æ—Ä–æ–≤ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏.
    `);
});

bot.hears('üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏', (ctx) => {
    ctx.replyWithMarkdown(`
*üìû –ü—Ä–∏—ë–º–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è:*

*–¢–µ–ª–µ—Ñ–æ–Ω—ã:*  
8 (800) 707-75-36  
+7 (812) 615-86-17  

*–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:*  
–ü–Ω-–ü—Ç: 9:00 - 18:00  

*Email:*  
priem@biscollege.ru  
    `);
});

bot.hears('üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã —É—á–µ–±–Ω–æ–π —á–∞—Å—Ç–∏', (ctx) => {
    ctx.replyWithMarkdown(`
*üìö –£—á–µ–±–Ω–∞—è —á–∞—Å—Ç—å:*

*–¢–µ–ª–µ—Ñ–æ–Ω:*  
+7 (812) 556-60-17  

*–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:*  
–ü–Ω-–ü—Ç: 9:00 - 17:30  

*Email:*  
info@biscollege.ru  
    `);
});

bot.on('sticker', (ctx) => {
    const reactions = [
        '–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä —Å—Ç–∏–∫–µ—Ä–∞!',
        'üòÑ –ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —ç—Ç–æ—Ç —Å—Ç–∏–∫–µ—Ä!',
        '–•–æ—Ä–æ—à–∏–π —Å—Ç–∏–∫–µ—Ä! –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—â–µ–Ω–∏–µ?',
        'üëç –ü–æ–Ω—Ä–∞–≤–∏–ª—Å—è –≤–∞—à —Å—Ç–∏–∫–µ—Ä!',
        '–í–∞—É, –∫—Ä—É—Ç–æ–π —Å—Ç–∏–∫–µ—Ä!',
        '–≠—Ç–æ—Ç —Å—Ç–∏–∫–µ—Ä ‚Äî –æ–≥–æ–Ω—å! üî•',
        '–¢–∞–∫–æ–π –º–∏–ª—ã–π —Å—Ç–∏–∫–µ—Ä!',
        '–•–∞-—Ö–∞, –∫–ª–∞—Å—Å–Ω–æ! üòÇ'
    ];
    
    const randomIndex = crypto.randomInt(0, reactions.length);
    ctx.reply(reactions[randomIndex]);
});

bot.launch()
    .then(() => console.log('ü§ñ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω'))
    .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', err));

export default bot;